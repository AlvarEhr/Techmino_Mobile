name: Android Test Build (Debug)

# Trigger on pushes to claude/* branches for testing
on:
  push:
    branches: [claude/*]
  workflow_dispatch:  # Allow manual trigger

env:
  BUILD_ASSETS_FOLDER: ./.github/build
  COLD_CLEAR_DOWNLOAD_URL: https://github.com/26F-Studio/cold_clear_ai_love2d_wrapper/releases/download/11.5
  CORE_LOVE_ARTIFACT_NAME: core_love_package
  CORE_LOVE_PACKAGE_PATH: ./core.love

jobs:
  get-info:
    runs-on: ubuntu-latest
    outputs:
      app-name: ${{ steps.app-info.outputs.app-name }}
      version-name: ${{ steps.app-info.outputs.version-name }}
      version-string: ${{ steps.app-info.outputs.version-string }}
      version-code: ${{ steps.app-info.outputs.version-code }}
      commit-hash: ${{ steps.git-info.outputs.commit-hash }}
      base-name: ${{ steps.assemble-base-name.outputs.base-name }}
    steps:
      - uses: actions/checkout@v4
      - name: Install lua
        run: |
          sudo apt-get install lua5.3 -y
      - name: Get app info
        id: app-info
        shell: lua {0}
        run: |
          local version = require "version"
          os.execute('echo "app-name=Techmino" >> $GITHUB_OUTPUT')
          os.execute('echo "version-name=' .. version.name .. '" >> $GITHUB_OUTPUT')
          os.execute('echo "version-string=' .. version.string:gsub("%a", "") .. '" >> $GITHUB_OUTPUT')
          os.execute('echo "version-code=' .. tostring(version.code) .. '" >> $GITHUB_OUTPUT')
      - name: Get git info
        id: git-info
        shell: bash
        run: |
          COMMIT_HASH=$(git rev-parse --short ${{ GITHUB.SHA }})
          echo "commit-hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
      - name: Assemble package base name
        id: assemble-base-name
        shell: bash
        run: |
          BASE_NAME=Techmino_${{ steps.app-info.outputs.version-string }}_${{ steps.git-info.outputs.commit-hash }}_#${{ GITHUB.RUN_NUMBER }}
          echo "base-name=$BASE_NAME" >> $GITHUB_OUTPUT

  build-core:
    runs-on: ubuntu-latest
    needs: get-info
    env:
      OUTPUT_FOLDER: ./build
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Process app name
        id: process-app-name
        shell: python3 {0}
        run: |
          import os
          import re
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
            f.write('product-name=' + re.sub(r'[^A-Za-z0-9]+', '_', '${{ needs.get-info.outputs.app-name }}') + '\n')
      - name: Build core love package
        uses: love-actions/love-actions-core@v1
        with:
          build-list: ./media/ ./parts/ ./Zframework/ ./conf.lua ./main.lua ./version.lua ./legals.md ./license.txt
          package-path: ${{ env.CORE_LOVE_PACKAGE_PATH }}
      - name: Upload core love package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.CORE_LOVE_ARTIFACT_NAME }}
          path: ${{ env.CORE_LOVE_PACKAGE_PATH }}
      - name: Rename love package
        run: |
          mkdir -p ${{ env.OUTPUT_FOLDER }}
          cp ${{ env.CORE_LOVE_PACKAGE_PATH }} ${{ env.OUTPUT_FOLDER }}/${{ steps.process-app-name.outputs.product-name }}.love
      - name: Upload love artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.get-info.outputs.base-name }}_Core_love
          path: ${{ env.OUTPUT_FOLDER }}/${{ steps.process-app-name.outputs.product-name }}.love

  build-android-debug:
    runs-on: ubuntu-latest
    needs: [get-info, build-core]
    env:
      COLD_CLEAR_FOLDER: ./libAndroid
      OUTPUT_FOLDER: ./build
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Process app name
        id: process-app-name
        shell: python3 {0}
        run: |
          import os
          import re
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
            f.write('bundle-id=org.f26_studio.' + re.sub(r'[^A-Za-z0-9]+', '_', '${{ needs.get-info.outputs.app-name }}') + '.debug\n')
            f.write('product-name=' + re.sub(r'[^A-Za-z0-9]+', '-', '${{ needs.get-info.outputs.app-name }}') + '_Debug\n')
      - name: Download core love package
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.CORE_LOVE_ARTIFACT_NAME }}
      - name: Download ColdClear
        uses: ./.github/actions/get-unzip
        with:
          url: ${{ env.COLD_CLEAR_DOWNLOAD_URL }}/Android.zip
          dir: ${{ env.COLD_CLEAR_FOLDER }}
      - name: Generate debug keystore
        id: generate-keystore
        shell: bash
        run: |
          # Generate a debug keystore (valid for testing only)
          keytool -genkey -v -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"

          # Convert to base64 for the action
          KEYSTORE_BASE64=$(base64 -w 0 debug.keystore)
          echo "keystore-base64=$KEYSTORE_BASE64" >> $GITHUB_OUTPUT
      - name: Build Android debug APK
        id: build-packages
        uses: love-actions/love-actions-android@v2
        with:
          app-name: ${{ needs.get-info.outputs.app-name }}
          bundle-id: ${{ steps.process-app-name.outputs.bundle-id }}
          icon-specifier: "@mipmap/icon"
          keystore-alias: androiddebugkey
          keystore-base64: ${{ steps.generate-keystore.outputs.keystore-base64 }}
          keystore-key-password: android
          keystore-store-password: android
          love-package: ${{ env.CORE_LOVE_PACKAGE_PATH }}
          resource-path: ${{ env.BUILD_ASSETS_FOLDER }}/android/dev/res
          extra-assets: ${{ env.COLD_CLEAR_FOLDER }}
          custom-scheme: studio26f://oauth
          product-name: ${{ steps.process-app-name.outputs.product-name }}
          version-string: ${{ needs.get-info.outputs.version-string }}
          version-code: ${{ needs.get-info.outputs.version-code }}
          output-folder: ${{ env.OUTPUT_FOLDER }}
      - name: List build output (debug)
        shell: bash
        run: |
          echo "Contents of build folder:"
          ls -lah ${{ env.OUTPUT_FOLDER }}/
      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.get-info.outputs.base-name }}_Android_Debug
          path: ${{ env.OUTPUT_FOLDER }}/${{ steps.process-app-name.outputs.product-name }}-release.apk
      - name: Comment on commit with download link
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const runId = context.runId;
            const repo = context.repo;
            const sha = context.sha;

            const comment = `### ðŸ¤– Android Debug Build Complete!

            **Download your APK:**
            - Go to [Actions Run #${runId}](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
            - Scroll to "Artifacts" section
            - Download: \`${{ needs.get-info.outputs.base-name }}_Android_Debug\`

            **Version:** ${{ needs.get-info.outputs.version-string }}
            **Commit:** ${sha.substring(0, 7)}

            This is a **debug build** with gesture controls enabled!`;

  cleanup:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [build-core, build-android-debug]
    steps:
      - name: Cleanup temporary artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: ${{ env.CORE_LOVE_ARTIFACT_NAME }}
